{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport { Platform } from '@unimodules/core';\nimport * as FileSystem from 'expo-file-system';\nimport Constants from 'expo-constants';\nimport computeMd5 from 'blueimp-md5';\nimport { getAssetByID } from \"./AssetRegistry\";\nimport resolveAssetSource from \"./resolveAssetSource\";\nimport * as AssetSources from \"./AssetSources\";\nimport * as AssetUris from \"./AssetUris\";\nimport * as EmbeddedAssets from \"./EmbeddedAssets\";\nimport * as ImageAssets from \"./ImageAssets\";\nvar IS_MANAGED_ENV = !!Constants.appOwnership;\nexport var Asset = function () {\n  function Asset(_ref) {\n    var name = _ref.name,\n        type = _ref.type,\n        _ref$hash = _ref.hash,\n        hash = _ref$hash === void 0 ? null : _ref$hash,\n        uri = _ref.uri,\n        width = _ref.width,\n        height = _ref.height;\n\n    _classCallCheck(this, Asset);\n\n    this.hash = null;\n    this.localUri = null;\n    this.width = null;\n    this.height = null;\n    this.downloading = false;\n    this.downloaded = false;\n    this._downloadCallbacks = [];\n    this.name = name;\n    this.type = type;\n    this.hash = hash;\n    this.uri = uri;\n\n    if (typeof width === 'number') {\n      this.width = width;\n    }\n\n    if (typeof height === 'number') {\n      this.height = height;\n    }\n\n    if (IS_MANAGED_ENV && hash) {\n      this.localUri = EmbeddedAssets.getEmbeddedAssetUri(hash, type);\n\n      if (this.localUri) {\n        this.downloaded = true;\n      }\n    }\n  }\n\n  _createClass(Asset, [{\n    key: \"_downloadAsyncWeb\",\n    value: function _downloadAsyncWeb() {\n      var _ref2, width, height, name;\n\n      return _regeneratorRuntime.async(function _downloadAsyncWeb$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!ImageAssets.isImageType(this.type)) {\n                _context.next = 12;\n                break;\n              }\n\n              _context.next = 3;\n              return _regeneratorRuntime.awrap(ImageAssets.getImageInfoAsync(this.uri));\n\n            case 3:\n              _ref2 = _context.sent;\n              width = _ref2.width;\n              height = _ref2.height;\n              name = _ref2.name;\n              this.width = width;\n              this.height = height;\n              this.name = name;\n              _context.next = 13;\n              break;\n\n            case 12:\n              this.name = AssetUris.getFilename(this.uri);\n\n            case 13:\n              this.localUri = this.uri;\n\n            case 14:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, null, this);\n    }\n  }, {\n    key: \"_downloadAsyncManagedEnv\",\n    value: function _downloadAsyncManagedEnv() {\n      var cacheFileId, localUri, _ref3, exists, md5, _ref4;\n\n      return _regeneratorRuntime.async(function _downloadAsyncManagedEnv$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              cacheFileId = this.hash || computeMd5(this.uri);\n              localUri = FileSystem.cacheDirectory + \"ExponentAsset-\" + cacheFileId + \".\" + this.type;\n              _context2.next = 4;\n              return _regeneratorRuntime.awrap(FileSystem.getInfoAsync(localUri, {\n                md5: true\n              }));\n\n            case 4:\n              _ref3 = _context2.sent;\n              exists = _ref3.exists;\n              md5 = _ref3.md5;\n\n              if (!(!exists || this.hash !== null && md5 !== this.hash)) {\n                _context2.next = 14;\n                break;\n              }\n\n              _context2.next = 10;\n              return _regeneratorRuntime.awrap(FileSystem.downloadAsync(this.uri, localUri, {\n                md5: true\n              }));\n\n            case 10:\n              _ref4 = _context2.sent;\n              md5 = _ref4.md5;\n\n              if (!(this.hash !== null && md5 !== this.hash)) {\n                _context2.next = 14;\n                break;\n              }\n\n              throw new Error(\"Downloaded file for asset '\" + this.name + \".\" + this.type + \"' \" + (\"Located at \" + this.uri + \" \") + \"failed MD5 integrity check\");\n\n            case 14:\n              this.localUri = localUri;\n\n            case 15:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, null, this);\n    }\n  }, {\n    key: \"_downloadAsyncUnmanagedEnv\",\n    value: function _downloadAsyncUnmanagedEnv() {\n      var cacheFileId, localUri;\n      return _regeneratorRuntime.async(function _downloadAsyncUnmanagedEnv$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              if (!this.uri.startsWith('file://')) {\n                _context3.next = 3;\n                break;\n              }\n\n              this.localUri = this.uri;\n              return _context3.abrupt(\"return\");\n\n            case 3:\n              cacheFileId = this.hash || computeMd5(this.uri);\n              localUri = FileSystem.cacheDirectory + \"ExponentAsset-\" + cacheFileId + \".\" + this.type;\n              _context3.next = 7;\n              return _regeneratorRuntime.awrap(FileSystem.downloadAsync(this.uri, localUri));\n\n            case 7:\n              this.localUri = localUri;\n\n            case 8:\n            case \"end\":\n              return _context3.stop();\n          }\n        }\n      }, null, this);\n    }\n  }, {\n    key: \"downloadAsync\",\n    value: function downloadAsync() {\n      var _this = this;\n\n      return _regeneratorRuntime.async(function downloadAsync$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              if (!this.downloaded) {\n                _context4.next = 2;\n                break;\n              }\n\n              return _context4.abrupt(\"return\");\n\n            case 2:\n              if (!this.downloading) {\n                _context4.next = 6;\n                break;\n              }\n\n              _context4.next = 5;\n              return _regeneratorRuntime.awrap(new Promise(function (resolve, reject) {\n                _this._downloadCallbacks.push({\n                  resolve: resolve,\n                  reject: reject\n                });\n              }));\n\n            case 5:\n              return _context4.abrupt(\"return\");\n\n            case 6:\n              this.downloading = true;\n              _context4.prev = 7;\n\n              if (!(Platform.OS === 'web')) {\n                _context4.next = 13;\n                break;\n              }\n\n              _context4.next = 11;\n              return _regeneratorRuntime.awrap(this._downloadAsyncWeb());\n\n            case 11:\n              _context4.next = 20;\n              break;\n\n            case 13:\n              if (!IS_MANAGED_ENV) {\n                _context4.next = 18;\n                break;\n              }\n\n              _context4.next = 16;\n              return _regeneratorRuntime.awrap(this._downloadAsyncManagedEnv());\n\n            case 16:\n              _context4.next = 20;\n              break;\n\n            case 18:\n              _context4.next = 20;\n              return _regeneratorRuntime.awrap(this._downloadAsyncUnmanagedEnv());\n\n            case 20:\n              this.downloaded = true;\n\n              this._downloadCallbacks.forEach(function (_ref5) {\n                var resolve = _ref5.resolve;\n                return resolve();\n              });\n\n              _context4.next = 28;\n              break;\n\n            case 24:\n              _context4.prev = 24;\n              _context4.t0 = _context4[\"catch\"](7);\n\n              this._downloadCallbacks.forEach(function (_ref6) {\n                var reject = _ref6.reject;\n                return reject(_context4.t0);\n              });\n\n              throw _context4.t0;\n\n            case 28:\n              _context4.prev = 28;\n              this.downloading = false;\n              this._downloadCallbacks = [];\n              return _context4.finish(28);\n\n            case 32:\n            case \"end\":\n              return _context4.stop();\n          }\n        }\n      }, null, this, [[7, 24, 28, 32]]);\n    }\n  }], [{\n    key: \"loadAsync\",\n    value: function loadAsync(moduleId) {\n      var moduleIds = Array.isArray(moduleId) ? moduleId : [moduleId];\n      return Promise.all(moduleIds.map(function (moduleId) {\n        return Asset.fromModule(moduleId).downloadAsync();\n      }));\n    }\n  }, {\n    key: \"fromModule\",\n    value: function fromModule(virtualAssetModule) {\n      if (typeof virtualAssetModule === 'string') {\n        return Asset.fromURI(virtualAssetModule);\n      }\n\n      var meta = getAssetByID(virtualAssetModule);\n\n      if (!meta) {\n        throw new Error(\"Module \\\"\" + virtualAssetModule + \"\\\" is missing from the asset registry\");\n      }\n\n      if (!IS_MANAGED_ENV) {\n        var _resolveAssetSource = resolveAssetSource(virtualAssetModule),\n            uri = _resolveAssetSource.uri;\n\n        var asset = new Asset({\n          name: meta.name,\n          type: meta.type,\n          hash: meta.hash,\n          uri: uri,\n          width: meta.width,\n          height: meta.height\n        });\n\n        if (Platform.OS === 'android' && !uri.includes(':') && (meta.width || meta.height)) {\n          asset.localUri = asset.uri;\n          asset.downloaded = true;\n        }\n\n        Asset.byHash[meta.hash] = asset;\n        return asset;\n      }\n\n      return Asset.fromMetadata(meta);\n    }\n  }, {\n    key: \"fromMetadata\",\n    value: function fromMetadata(meta) {\n      var metaHash = meta.hash;\n\n      if (Asset.byHash[metaHash]) {\n        return Asset.byHash[metaHash];\n      } else if (!IS_MANAGED_ENV && !Asset.byHash[metaHash]) {\n        throw new Error('Assets must be initialized with Asset.fromModule');\n      }\n\n      var _AssetSources$selectA = AssetSources.selectAssetSource(meta),\n          uri = _AssetSources$selectA.uri,\n          hash = _AssetSources$selectA.hash;\n\n      var asset = new Asset({\n        name: meta.name,\n        type: meta.type,\n        hash: hash,\n        uri: uri,\n        width: meta.width,\n        height: meta.height\n      });\n      Asset.byHash[metaHash] = asset;\n      return asset;\n    }\n  }, {\n    key: \"fromURI\",\n    value: function fromURI(uri) {\n      if (Asset.byUri[uri]) {\n        return Asset.byUri[uri];\n      }\n\n      var type = '';\n\n      if (uri.indexOf(';base64') > -1) {\n        type = uri.split(';')[0].split('/')[1];\n      } else {\n        var extension = AssetUris.getFileExtension(uri);\n        type = extension.startsWith('.') ? extension.substring(1) : extension;\n      }\n\n      var asset = new Asset({\n        name: '',\n        type: type,\n        hash: null,\n        uri: uri\n      });\n      Asset.byUri[uri] = asset;\n      return asset;\n    }\n  }]);\n\n  return Asset;\n}();\nAsset.byHash = {};\nAsset.byUri = {};","map":{"version":3,"sources":["../src/Asset.ts"],"names":[],"mappings":";;;AAAA,SAAS,QAAT,QAAyB,kBAAzB;AACA,OAAO,KAAK,UAAZ,MAA4B,kBAA5B;AACA,OAAO,SAAP,MAAsB,gBAAtB;AACA,OAAO,UAAP,MAAuB,aAAvB;AACA,SAAS,YAAT;AACA,OAAO,kBAAP;AAEA,OAAO,KAAK,YAAZ;AACA,OAAO,KAAK,SAAZ;AACA,OAAO,KAAK,cAAZ;AACA,OAAO,KAAK,WAAZ;AAkBA,IAAM,cAAc,GAAG,CAAC,CAAC,SAAS,CAAC,YAAnC;AAEA,WAAa,KAAb;AAeE,uBAA4E;AAAA,QAA9D,IAA8D,QAA9D,IAA8D;AAAA,QAAxD,IAAwD,QAAxD,IAAwD;AAAA,yBAAlD,IAAkD;AAAA,QAAlD,IAAkD,0BAA3C,IAA2C;AAAA,QAArC,GAAqC,QAArC,GAAqC;AAAA,QAAhC,KAAgC,QAAhC,KAAgC;AAAA,QAAzB,MAAyB,QAAzB,MAAyB;;AAAA;;AAT5E,SAAA,IAAA,GAAsB,IAAtB;AAEA,SAAA,QAAA,GAA0B,IAA1B;AACA,SAAA,KAAA,GAAuB,IAAvB;AACA,SAAA,MAAA,GAAwB,IAAxB;AACA,SAAA,WAAA,GAAuB,KAAvB;AACA,SAAA,UAAA,GAAsB,KAAtB;AACA,SAAA,kBAAA,GAAiD,EAAjD;AAGE,SAAK,IAAL,GAAY,IAAZ;AACA,SAAK,IAAL,GAAY,IAAZ;AACA,SAAK,IAAL,GAAY,IAAZ;AACA,SAAK,GAAL,GAAW,GAAX;;AAEA,QAAI,OAAO,KAAP,KAAiB,QAArB,EAA+B;AAC7B,WAAK,KAAL,GAAa,KAAb;AACD;;AACD,QAAI,OAAO,MAAP,KAAkB,QAAtB,EAAgC;AAC9B,WAAK,MAAL,GAAc,MAAd;AACD;;AAGD,QAAI,cAAc,IAAI,IAAtB,EAA4B;AAC1B,WAAK,QAAL,GAAgB,cAAc,CAAC,mBAAf,CAAmC,IAAnC,EAAyC,IAAzC,CAAhB;;AACA,UAAI,KAAK,QAAT,EAAmB;AACjB,aAAK,UAAL,GAAkB,IAAlB;AACD;AACF;AACF;;AAnCH;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,mBAmIQ,WAAW,CAAC,WAAZ,CAAwB,KAAK,IAA7B,CAnIR;AAAA;AAAA;AAAA;;AAAA;AAAA,+CAoI4C,WAAW,CAAC,iBAAZ,CAA8B,KAAK,GAAnC,CApI5C;;AAAA;AAAA;AAoIc,cAAA,KApId,SAoIc,KApId;AAoIqB,cAAA,MApIrB,SAoIqB,MApIrB;AAoI6B,cAAA,IApI7B,SAoI6B,IApI7B;AAqIM,mBAAK,KAAL,GAAa,KAAb;AACA,mBAAK,MAAL,GAAc,MAAd;AACA,mBAAK,IAAL,GAAY,IAAZ;AAvIN;AAAA;;AAAA;AAyIM,mBAAK,IAAL,GAAY,SAAS,CAAC,WAAV,CAAsB,KAAK,GAA3B,CAAZ;;AAzIN;AA2II,mBAAK,QAAL,GAAgB,KAAK,GAArB;;AA3IJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AA+IU,cAAA,WA/IV,GA+IwB,KAAK,IAAL,IAAa,UAAU,CAAC,KAAK,GAAN,CA/I/C;AAgJU,cAAA,QAhJV,GAgJwB,UAAU,CAAC,cAhJnC,sBAgJkE,WAhJlE,SAgJiF,KAAK,IAhJtF;AAAA;AAAA,+CAiJgC,UAAU,CAAC,YAAX,CAAwB,QAAxB,EAAkC;AAC5D,gBAAA,GAAG,EAAE;AADuD,eAAlC,CAjJhC;;AAAA;AAAA;AAiJU,cAAA,MAjJV,SAiJU,MAjJV;AAiJkB,cAAA,GAjJlB,SAiJkB,GAjJlB;;AAAA,oBAoJQ,CAAC,MAAD,IAAY,KAAK,IAAL,KAAc,IAAd,IAAsB,GAAG,KAAK,KAAK,IApJvD;AAAA;AAAA;AAAA;;AAAA;AAAA,+CAqJuB,UAAU,CAAC,aAAX,CAAyB,KAAK,GAA9B,EAAmC,QAAnC,EAA6C;AAC5D,gBAAA,GAAG,EAAE;AADuD,eAA7C,CArJvB;;AAAA;AAAA;AAqJS,cAAA,GArJT,SAqJS,GArJT;;AAAA,oBAwJU,KAAK,IAAL,KAAc,IAAd,IAAsB,GAAG,KAAK,KAAK,IAxJ7C;AAAA;AAAA;AAAA;;AAAA,oBAyJc,IAAI,KAAJ,CACJ,gCAA8B,KAAK,IAAnC,SAA2C,KAAK,IAAhD,2BACgB,KAAK,GADrB,sCADI,CAzJd;;AAAA;AAiKI,mBAAK,QAAL,GAAgB,QAAhB;;AAjKJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mBAsKQ,KAAK,GAAL,CAAS,UAAT,CAAoB,SAApB,CAtKR;AAAA;AAAA;AAAA;;AAuKM,mBAAK,QAAL,GAAgB,KAAK,GAArB;AAvKN;;AAAA;AA2KU,cAAA,WA3KV,GA2KwB,KAAK,IAAL,IAAa,UAAU,CAAC,KAAK,GAAN,CA3K/C;AA4KU,cAAA,QA5KV,GA4KwB,UAAU,CAAC,cA5KnC,sBA4KkE,WA5KlE,SA4KiF,KAAK,IA5KtF;AAAA;AAAA,+CA+KU,UAAU,CAAC,aAAX,CAAyB,KAAK,GAA9B,EAAmC,QAAnC,CA/KV;;AAAA;AAgLI,mBAAK,QAAL,GAAgB,QAAhB;;AAhLJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,mBAoLQ,KAAK,UApLb;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA,mBAuLQ,KAAK,WAvLb;AAAA;AAAA;AAAA;;AAAA;AAAA,+CAwLY,IAAI,OAAJ,CAAY,UAAC,OAAD,EAAU,MAAV,EAAoB;AACpC,gBAAA,KAAI,CAAC,kBAAL,CAAwB,IAAxB,CAA6B;AAAE,kBAAA,OAAO,EAAP,OAAF;AAAW,kBAAA,MAAM,EAAN;AAAX,iBAA7B;AACD,eAFK,CAxLZ;;AAAA;AAAA;;AAAA;AA6LI,mBAAK,WAAL,GAAmB,IAAnB;AA7LJ;;AAAA,oBAgMU,QAAQ,CAAC,EAAT,KAAgB,KAhM1B;AAAA;AAAA;AAAA;;AAAA;AAAA,+CAiMc,KAAK,iBAAL,EAjMd;;AAAA;AAAA;AAAA;;AAAA;AAAA,mBAkMiB,cAlMjB;AAAA;AAAA;AAAA;;AAAA;AAAA,+CAmMc,KAAK,wBAAL,EAnMd;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,+CAqMc,KAAK,0BAAL,EArMd;;AAAA;AAwMM,mBAAK,UAAL,GAAkB,IAAlB;;AACA,mBAAK,kBAAL,CAAwB,OAAxB,CAAgC;AAAA,oBAAG,OAAH,SAAG,OAAH;AAAA,uBAAiB,OAAO,EAAxB;AAAA,eAAhC;;AAzMN;AAAA;;AAAA;AAAA;AAAA;;AA2MM,mBAAK,kBAAL,CAAwB,OAAxB,CAAgC;AAAA,oBAAG,MAAH,SAAG,MAAH;AAAA,uBAAgB,MAAM,cAAtB;AAAA,eAAhC;;AA3MN;;AAAA;AAAA;AA8MM,mBAAK,WAAL,GAAmB,KAAnB;AACA,mBAAK,kBAAL,GAA0B,EAA1B;AA/MN;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAqCmB,QArCnB,EAqC8C;AAC1C,UAAM,SAAS,GAAG,KAAK,CAAC,OAAN,CAAc,QAAd,IAA0B,QAA1B,GAAqC,CAAC,QAAD,CAAvD;AACA,aAAO,OAAO,CAAC,GAAR,CAAY,SAAS,CAAC,GAAV,CAAc,UAAA,QAAQ;AAAA,eAAI,KAAK,CAAC,UAAN,CAAiB,QAAjB,EAA2B,aAA3B,EAAJ;AAAA,OAAtB,CAAZ,CAAP;AACD;AAxCH;AAAA;AAAA,+BA0CoB,kBA1CpB,EA0CuD;AACnD,UAAI,OAAO,kBAAP,KAA8B,QAAlC,EAA4C;AAC1C,eAAO,KAAK,CAAC,OAAN,CAAc,kBAAd,CAAP;AACD;;AAED,UAAM,IAAI,GAAG,YAAY,CAAC,kBAAD,CAAzB;;AACA,UAAI,CAAC,IAAL,EAAW;AACT,cAAM,IAAI,KAAJ,eAAqB,kBAArB,2CAAN;AACD;;AAID,UAAI,CAAC,cAAL,EAAqB;AAAA,kCACH,kBAAkB,CAAC,kBAAD,CADf;AAAA,YACX,GADW,uBACX,GADW;;AAEnB,YAAM,KAAK,GAAG,IAAI,KAAJ,CAAU;AACtB,UAAA,IAAI,EAAE,IAAI,CAAC,IADW;AAEtB,UAAA,IAAI,EAAE,IAAI,CAAC,IAFW;AAGtB,UAAA,IAAI,EAAE,IAAI,CAAC,IAHW;AAItB,UAAA,GAAG,EAAH,GAJsB;AAKtB,UAAA,KAAK,EAAE,IAAI,CAAC,KALU;AAMtB,UAAA,MAAM,EAAE,IAAI,CAAC;AANS,SAAV,CAAd;;AAaA,YAAI,QAAQ,CAAC,EAAT,KAAgB,SAAhB,IAA6B,CAAC,GAAG,CAAC,QAAJ,CAAa,GAAb,CAA9B,KAAoD,IAAI,CAAC,KAAL,IAAc,IAAI,CAAC,MAAvE,CAAJ,EAAoF;AAClF,UAAA,KAAK,CAAC,QAAN,GAAiB,KAAK,CAAC,GAAvB;AACA,UAAA,KAAK,CAAC,UAAN,GAAmB,IAAnB;AACD;;AAED,QAAA,KAAK,CAAC,MAAN,CAAa,IAAI,CAAC,IAAlB,IAA0B,KAA1B;AACA,eAAO,KAAP;AACD;;AAED,aAAO,KAAK,CAAC,YAAN,CAAmB,IAAnB,CAAP;AACD;AA/EH;AAAA;AAAA,iCAiFsB,IAjFtB,EAiFyC;AAGrC,UAAM,QAAQ,GAAG,IAAI,CAAC,IAAtB;;AACA,UAAI,KAAK,CAAC,MAAN,CAAa,QAAb,CAAJ,EAA4B;AAC1B,eAAO,KAAK,CAAC,MAAN,CAAa,QAAb,CAAP;AACD,OAFD,MAEO,IAAI,CAAC,cAAD,IAAmB,CAAC,KAAK,CAAC,MAAN,CAAa,QAAb,CAAxB,EAAgD;AACrD,cAAM,IAAI,KAAJ,CAAU,kDAAV,CAAN;AACD;;AARoC,kCAUf,YAAY,CAAC,iBAAb,CAA+B,IAA/B,CAVe;AAAA,UAU7B,GAV6B,yBAU7B,GAV6B;AAAA,UAUxB,IAVwB,yBAUxB,IAVwB;;AAWrC,UAAM,KAAK,GAAG,IAAI,KAAJ,CAAU;AACtB,QAAA,IAAI,EAAE,IAAI,CAAC,IADW;AAEtB,QAAA,IAAI,EAAE,IAAI,CAAC,IAFW;AAGtB,QAAA,IAAI,EAAJ,IAHsB;AAItB,QAAA,GAAG,EAAH,GAJsB;AAKtB,QAAA,KAAK,EAAE,IAAI,CAAC,KALU;AAMtB,QAAA,MAAM,EAAE,IAAI,CAAC;AANS,OAAV,CAAd;AAQA,MAAA,KAAK,CAAC,MAAN,CAAa,QAAb,IAAyB,KAAzB;AACA,aAAO,KAAP;AACD;AAtGH;AAAA;AAAA,4BAwGiB,GAxGjB,EAwG4B;AACxB,UAAI,KAAK,CAAC,KAAN,CAAY,GAAZ,CAAJ,EAAsB;AACpB,eAAO,KAAK,CAAC,KAAN,CAAY,GAAZ,CAAP;AACD;;AAGD,UAAI,IAAI,GAAG,EAAX;;AACA,UAAI,GAAG,CAAC,OAAJ,CAAY,SAAZ,IAAyB,CAAC,CAA9B,EAAiC;AAC/B,QAAA,IAAI,GAAG,GAAG,CAAC,KAAJ,CAAU,GAAV,EAAe,CAAf,EAAkB,KAAlB,CAAwB,GAAxB,EAA6B,CAA7B,CAAP;AACD,OAFD,MAEO;AACL,YAAM,SAAS,GAAG,SAAS,CAAC,gBAAV,CAA2B,GAA3B,CAAlB;AACA,QAAA,IAAI,GAAG,SAAS,CAAC,UAAV,CAAqB,GAArB,IAA4B,SAAS,CAAC,SAAV,CAAoB,CAApB,CAA5B,GAAqD,SAA5D;AACD;;AAED,UAAM,KAAK,GAAG,IAAI,KAAJ,CAAU;AACtB,QAAA,IAAI,EAAE,EADgB;AAEtB,QAAA,IAAI,EAAJ,IAFsB;AAGtB,QAAA,IAAI,EAAE,IAHgB;AAItB,QAAA,GAAG,EAAH;AAJsB,OAAV,CAAd;AAOA,MAAA,KAAK,CAAC,KAAN,CAAY,GAAZ,IAAmB,KAAnB;AAEA,aAAO,KAAP;AACD;AAhIH;;AAAA;AAAA;AACS,KAAA,CAAA,MAAA,GAAS,EAAT;AACA,KAAA,CAAA,KAAA,GAAQ,EAAR","sourcesContent":["import { Platform } from '@unimodules/core';\nimport * as FileSystem from 'expo-file-system';\nimport Constants from 'expo-constants';\nimport computeMd5 from 'blueimp-md5';\nimport { getAssetByID } from './AssetRegistry';\nimport resolveAssetSource from './resolveAssetSource';\n\nimport * as AssetSources from './AssetSources';\nimport * as AssetUris from './AssetUris';\nimport * as EmbeddedAssets from './EmbeddedAssets';\nimport * as ImageAssets from './ImageAssets';\n\ntype AssetDescriptor = {\n  name: string;\n  type: string;\n  hash?: string | null;\n  uri: string;\n  width?: number | null;\n  height?: number | null;\n};\n\ntype DownloadPromiseCallbacks = {\n  resolve: () => void;\n  reject: (error: Error) => void;\n};\n\nexport type AssetMetadata = AssetSources.AssetMetadata;\n\nconst IS_MANAGED_ENV = !!Constants.appOwnership;\n\nexport class Asset {\n  static byHash = {};\n  static byUri = {};\n\n  name: string;\n  type: string;\n  hash: string | null = null;\n  uri: string;\n  localUri: string | null = null;\n  width: number | null = null;\n  height: number | null = null;\n  downloading: boolean = false;\n  downloaded: boolean = false;\n  _downloadCallbacks: DownloadPromiseCallbacks[] = [];\n\n  constructor({ name, type, hash = null, uri, width, height }: AssetDescriptor) {\n    this.name = name;\n    this.type = type;\n    this.hash = hash;\n    this.uri = uri;\n\n    if (typeof width === 'number') {\n      this.width = width;\n    }\n    if (typeof height === 'number') {\n      this.height = height;\n    }\n\n    // This only applies to assets that are bundled in Expo standalone apps\n    if (IS_MANAGED_ENV && hash) {\n      this.localUri = EmbeddedAssets.getEmbeddedAssetUri(hash, type);\n      if (this.localUri) {\n        this.downloaded = true;\n      }\n    }\n  }\n\n  static loadAsync(moduleId: number | number[]): Promise<void[]> {\n    const moduleIds = Array.isArray(moduleId) ? moduleId : [moduleId];\n    return Promise.all(moduleIds.map(moduleId => Asset.fromModule(moduleId).downloadAsync()));\n  }\n\n  static fromModule(virtualAssetModule: number | string): Asset {\n    if (typeof virtualAssetModule === 'string') {\n      return Asset.fromURI(virtualAssetModule);\n    }\n\n    const meta = getAssetByID(virtualAssetModule);\n    if (!meta) {\n      throw new Error(`Module \"${virtualAssetModule}\" is missing from the asset registry`);\n    }\n\n    // Outside of the managed env we need the moduleId to initialize the asset\n    // because resolveAssetSource depends on it\n    if (!IS_MANAGED_ENV) {\n      const { uri } = resolveAssetSource(virtualAssetModule);\n      const asset = new Asset({\n        name: meta.name,\n        type: meta.type,\n        hash: meta.hash,\n        uri,\n        width: meta.width,\n        height: meta.height,\n      });\n\n      // TODO: FileSystem should probably support 'downloading' from drawable\n      // resources But for now it doesn't (it only supports raw resources) and\n      // React Native's Image works fine with drawable resource names for\n      // images.\n      if (Platform.OS === 'android' && !uri.includes(':') && (meta.width || meta.height)) {\n        asset.localUri = asset.uri;\n        asset.downloaded = true;\n      }\n\n      Asset.byHash[meta.hash] = asset;\n      return asset;\n    }\n\n    return Asset.fromMetadata(meta);\n  }\n\n  static fromMetadata(meta: AssetMetadata): Asset {\n    // The hash of the whole asset, not to be confused with the hash of a specific file returned\n    // from `selectAssetSource`\n    const metaHash = meta.hash;\n    if (Asset.byHash[metaHash]) {\n      return Asset.byHash[metaHash];\n    } else if (!IS_MANAGED_ENV && !Asset.byHash[metaHash]) {\n      throw new Error('Assets must be initialized with Asset.fromModule');\n    }\n\n    const { uri, hash } = AssetSources.selectAssetSource(meta);\n    const asset = new Asset({\n      name: meta.name,\n      type: meta.type,\n      hash,\n      uri,\n      width: meta.width,\n      height: meta.height,\n    });\n    Asset.byHash[metaHash] = asset;\n    return asset;\n  }\n\n  static fromURI(uri: string): Asset {\n    if (Asset.byUri[uri]) {\n      return Asset.byUri[uri];\n    }\n\n    // Possibly a Base64-encoded URI\n    let type = '';\n    if (uri.indexOf(';base64') > -1) {\n      type = uri.split(';')[0].split('/')[1];\n    } else {\n      const extension = AssetUris.getFileExtension(uri);\n      type = extension.startsWith('.') ? extension.substring(1) : extension;\n    }\n\n    const asset = new Asset({\n      name: '',\n      type,\n      hash: null,\n      uri,\n    });\n\n    Asset.byUri[uri] = asset;\n\n    return asset;\n  }\n\n  async _downloadAsyncWeb(): Promise<void> {\n    if (ImageAssets.isImageType(this.type)) {\n      const { width, height, name } = await ImageAssets.getImageInfoAsync(this.uri);\n      this.width = width;\n      this.height = height;\n      this.name = name;\n    } else {\n      this.name = AssetUris.getFilename(this.uri);\n    }\n    this.localUri = this.uri;\n  }\n\n  async _downloadAsyncManagedEnv(): Promise<void> {\n    const cacheFileId = this.hash || computeMd5(this.uri);\n    const localUri = `${FileSystem.cacheDirectory}ExponentAsset-${cacheFileId}.${this.type}`;\n    let { exists, md5 } = await FileSystem.getInfoAsync(localUri, {\n      md5: true,\n    });\n    if (!exists || (this.hash !== null && md5 !== this.hash)) {\n      ({ md5 } = await FileSystem.downloadAsync(this.uri, localUri, {\n        md5: true,\n      }));\n      if (this.hash !== null && md5 !== this.hash) {\n        throw new Error(\n          `Downloaded file for asset '${this.name}.${this.type}' ` +\n            `Located at ${this.uri} ` +\n            `failed MD5 integrity check`\n        );\n      }\n    }\n\n    this.localUri = localUri;\n  }\n\n  async _downloadAsyncUnmanagedEnv(): Promise<void> {\n    // Bail out if it's already at a file URL because it's already available locally\n    if (this.uri.startsWith('file://')) {\n      this.localUri = this.uri;\n      return;\n    }\n\n    const cacheFileId = this.hash || computeMd5(this.uri);\n    const localUri = `${FileSystem.cacheDirectory}ExponentAsset-${cacheFileId}.${this.type}`;\n    // We don't check the FileSystem for an existing version of the asset and we\n    // also don't perform an integrity check!\n    await FileSystem.downloadAsync(this.uri, localUri);\n    this.localUri = localUri;\n  }\n\n  async downloadAsync(): Promise<void> {\n    if (this.downloaded) {\n      return;\n    }\n    if (this.downloading) {\n      await new Promise((resolve, reject) => {\n        this._downloadCallbacks.push({ resolve, reject });\n      });\n      return;\n    }\n    this.downloading = true;\n\n    try {\n      if (Platform.OS === 'web') {\n        await this._downloadAsyncWeb();\n      } else if (IS_MANAGED_ENV) {\n        await this._downloadAsyncManagedEnv();\n      } else {\n        await this._downloadAsyncUnmanagedEnv();\n      }\n\n      this.downloaded = true;\n      this._downloadCallbacks.forEach(({ resolve }) => resolve());\n    } catch (e) {\n      this._downloadCallbacks.forEach(({ reject }) => reject(e));\n      throw e;\n    } finally {\n      this.downloading = false;\n      this._downloadCallbacks = [];\n    }\n  }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}